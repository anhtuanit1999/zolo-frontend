<!DOCTYPE html>
<html>

<head>
  <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
  <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
  <!-- Load an icon library to show a hamburger menu (bars) on small screens -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <!------ Include the above in your HEAD tag ---------->

  <title>
    <%= title %>
  </title>
  <link rel='stylesheet' href='/stylesheets/style.css' />
</head>

<body>
  <script src="/javascripts/index.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <div class="container app">
    <div class="row app-one">
      <div class="col-sm-4 side">
        <div class="side-one">
          <div class="row heading">
            <div class="col-sm-3 col-xs-3 heading-avatar">
              <span id="userid" hidden="true"><%= user.id %></span>
              <span id="groupid" hidden="true"></span>
              <span id="messlastid" hidden="true"></span>
              <div class="heading-avatar-icon">
                <img src="https://bootdey.com/img/Content/avatar/avatar1.png">
              </div>
            </div>
            <div class="col-sm-1 col-xs-1  heading-dot  pull-right">
              <i onclick="myFunction()" class="fa fa-ellipsis-v fa-2x  pull-right" aria-hidden="true"></i>
            </div>
            <div class="col-sm-2 col-xs-2 heading-compose  pull-right">
              <i class="fa fa-comments fa-2x  pull-right" aria-hidden="true"></i>
            </div>
          </div>

          <!-- Top Navigation Menu -->
          <div id="myLinks" class="row searchBox" style="display: none;">
            <div class="col-sm-12 searchBox-inner previous">
              <a class="row searchBox" href="#">Tạo nhóm</a>
              <a class="row searchBox" href="#">Danh sách bạn chờ</a>
              <a class="row searchBox" href="#">Danh sách đen</a>
            </div>
          </div>

          <div class="row searchBox">
            <div class="col-sm-12 searchBox-inner">
              <div class="form-group has-feedback">
                <input id="searchText" type="text" class="form-control" name="searchText" placeholder="Search">
                <!-- <span class="glyphicon glyphicon-search form-control-feedback"></span> -->
              </div>
            </div>
          </div>
          <!-- Groups -->
          <div class="row sideBar">
            <% if(groupsLen == 0) { %>
              <div class="row sideBar-body">
                Không tìm thấy nhóm chat nào
              </div>
              <% } else { %>
                <% for(let i = 0; i < groupsLen; i++) { %>
                  <div class="row sideBar-body">
                    <div class="col-sm-3 col-xs-3 sideBar-avatar">
                      <div class="avatar-icon">
                        <img src="https://bootdey.com/img/Content/avatar/avatar1.png">
                      </div>
                    </div>
                    <div class="col-sm-9 col-xs-9 sideBar-main">
                      <div class="row">
                        <div class="col-sm-8 col-xs-8 sideBar-name">
                          <span hidden="true" class="chatgroupidindex"><%= groups[i].id %></span>
                          <span class="name-meta chatgroupnameindex"><%= groups[i].name %></span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <% } %>
                    <% } %>
          </div>
        </div>

        <div class="side-two">
          <div class="row newMessage-heading">
            <div class="row newMessage-main">
              <div class="col-sm-2 col-xs-2 newMessage-back">
                <i class="fa fa-arrow-left" aria-hidden="true"></i>
              </div>
              <div class="col-sm-10 col-xs-10 newMessage-title">
                Danh sách bạn bè
              </div>
            </div>
          </div>

          <div class="row composeBox">
            <div class="col-sm-12 composeBox-inner">
              <div class="form-group has-feedback">
                <input id="composeText" type="text" class="form-control" name="searchText" placeholder="Search People">
                <!-- <span class="glyphicon glyphicon-search form-control-feedback"></span> -->
              </div>
            </div>
          </div>
          <!-- Friends -->
          <div class="row compose-sideBar">
            <% if(friendsLen == 0) { %>
              <div class="friend row sideBar-body">
                Không tìm thấy bạn bè
              </div>
              <% } else { %>
                <% for(let i = 0; i < friendsLen; i++) { %>
                  <div class="friend row sideBar-body">
                    <div class="col-sm-3 col-xs-3 sideBar-avatar">
                      <div class="avatar-icon">
                        <img src="https://bootdey.com/img/Content/avatar/avatar1.png">
                      </div>
                    </div>
                    <div class="col-sm-9 col-xs-9 sideBar-main">
                      <div class="row">
                        <div class="col-sm-8 col-xs-8 sideBar-name">
                          <span class="name-meta"><%= friends[i].fullName%></span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <% } %>
                    <% } %>
          </div>
        </div>
      </div>
      <!-- Box Chat -->
      <div class="col-sm-8 conversation">
        <div class="row heading">
          <div class="col-sm-2 col-md-1 col-xs-3 heading-avatar">
            <div class="heading-avatar-icon">
              <img src="https://bootdey.com/img/Content/avatar/avatar6.png">
            </div>
          </div>
          <div class="col-sm-8 col-xs-7 heading-name">
            <a class="heading-name-meta">Home
          </a>
            <span class="heading-online">Online</span>
          </div>
          <div class="col-sm-1 col-xs-1  heading-dot pull-right">
            <i class="fa fa-ellipsis-v fa-2x  pull-right" aria-hidden="true"></i>
          </div>
        </div>

        <div class="row message" id="conversation">
          <span id="chatgroupid" hidden="true">0</span>
          <div id="messPrevious" class="row message-previous">
            <div class="col-sm-12 previous">
              <a href="javascript:void(0)" id="btnShowMoreMessage" name="20">
            Show Previous Message!
            </a>
            </div>
          </div>
          <!-- chat -->

        </div>
        <!-- Box trả lời -->
        <div class="row reply">
          <div class="col-sm-1 col-xs-1 reply-emojis">
            <i class="fa fa-smile-o fa-2x"></i>
          </div>
          <div class="col-sm-9 col-xs-9 reply-main">
            <textarea class="form-control" rows="1" id="comment"></textarea>
          </div>
          <div class="col-sm-1 col-xs-1 reply-recording">
            <i id="btnMicro" class="fa fa-microphone fa-2x" aria-hidden="true"></i>
          </div>
          <div id="btnSend" class="col-sm-1 col-xs-1 reply-send">
            <i class="fa fa-send fa-2x" aria-hidden="true"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script>
    const showMoreMessage = () => {
      const groupId = $('#groupid').text();
      const lastId = $('#messlastid').text();
      if (groupId.length > 0 && lastId.length > 0) {
        $.ajax({
          type: 'POST',
          url: '/message/getall',
          data: {
            chatgroupId: +groupId,
            limit: 50,
            lastId: +lastId
          },
          success: function(result, err, xhr) {
            if (xhr.responseJSON.length <= 0) return;
            for (let i = 0; i < xhr.responseJSON.length; i++) {
              appendTopMess(
                xhr.responseJSON[i].content,
                xhr.responseJSON[i].type,
                new Date(xhr.responseJSON[i].createAt),
                xhr.responseJSON[i].user);
            }
            // set lastId message
            $('#messlastid').text(xhr.responseJSON[xhr.responseJSON.length - 1].id);
            $('#messPrevious').detach().prependTo('#conversation');
            scrollToTop();
          }
        })
      }
    }

    function myFunction() {
      var x = document.getElementById("myLinks");
      if (x.style.display === "block") {
        x.style.display = "none";
      } else {
        x.style.display = "block";
      }
    }
    const scrollToBottom = () => {
      $('#conversation').scrollTop($('#conversation').prop('scrollHeight'));
    };
    const scrollToTop = () => {
      $('#conversation').scrollTop(0);
    };
    const showGroup = () => {
      const groupId = $('.row.sideBar-body .chatgroupidindex').text();
      $('#groupid').text(groupId);
      // group name
      $('.conversation .heading-name .heading-name-meta')
        .text($('.row.sideBar-body .chatgroupnameindex').text());
      // group body
      $('#conversation').empty().append(`
        <span id="chatgroupid" hidden="true">${$('.row.sideBar-body .chatgroupidindex').text()}</span>
        <div id="messPrevious" class="row message-previous">
            <div class="col-sm-12 previous">
              <a onclick="showMoreMessage()" id="btnShowMoreMessage" name="20">
            Show Previous Message!
            </a>
            </div>
          </div>
      `);
      $.ajax({
        type: 'POST',
        url: '/message/getall',
        data: {
          chatgroupId: +groupId,
          limit: 50,
          lastId: 0
        },
        success: function(result, err, xhr) {
          for (let i = xhr.responseJSON.length - 1; i >= 0; i--) {
            appendMess(
              xhr.responseJSON[i].content,
              xhr.responseJSON[i].type,
              new Date(xhr.responseJSON[i].createAt),
              xhr.responseJSON[i].user);
          }
          // set lastId message
          $('#messlastid').text(xhr.responseJSON[xhr.responseJSON.length - 1].id);
          scrollToBottom();
        }
      })
    }
    const appendTopMess = (mess, type, time, header) => {
      if (!header) {
        const conversation = $('#conversation').prepend(
          `<div class="row message-body">
            <div class="col-sm-12 message-main-${type}">
              <div class="${type}">
                <div class="message-text">
                  ${mess}
                </div>
                <div class="message-text sender-or-receiver">
                  ${time.getHours()}:${time.getMinutes()}
                </div>
              </div>
            </div>
          </div>`
        );
        return;
      }
      const conversation = $('#conversation').prepend(
        `<div class="row message-body">
            <div class="col-sm-12 message-main-${type}">
              <div class="${type}">
                <div class="message-text sender-or-receiver">
                  ${type == 'receiver' ? header : ''}
                </div>
                <div class="message-text">
                  ${mess}
                </div>
                <div class="message-text sender-or-receiver">
                  ${time.getHours()}:${time.getMinutes()}
                </div>
              </div>
            </div>
          </div>`
      );
    };
    const appendMess = (mess, type, time, header) => {
      if (!header) {
        const conversation = $('#conversation').append(
          `<div class="row message-body">
            <div class="col-sm-12 message-main-${type}">
              <div class="${type}">
                <div class="message-text">
                  ${mess}
                </div>
                <div class="message-text sender-or-receiver">
                  ${time.getHours()}:${time.getMinutes()}
                </div>
              </div>
            </div>
          </div>`
        );
        return;
      }
      const conversation = $('#conversation').append(
        `<div class="row message-body">
            <div class="col-sm-12 message-main-${type}">
              <div class="${type}">
                <div class="message-text sender-or-receiver">
                  ${type == 'receiver' ? header : ''}
                </div>
                <div class="message-text">
                  ${mess}
                </div>
                <div class="message-text sender-or-receiver">
                  ${time.getHours()}:${time.getMinutes()}
                </div>
              </div>
            </div>
          </div>`
      );
    };
    const saveMessage = (data) => {
      $.ajax({
        type: 'POST',
        url: '/message/create',
        data: {
          chatgroupId: data.chatgroupId,
          userId: data.userId,
          content: data.mess
        },
        success: function(result, err, xhr) {
          if (!err) console.log('save done!');
        }
      })
    }
    const sendMess = (socket) => {
      const mess = $('#comment').val();
      if (mess.trim() !== '') {
        const data = {
          chatgroupId: +$('#chatgroupid').text(),
          userId: +$('#userid').text(),
          mess
        };
        saveMessage(data);
        appendMess(mess, 'sender', new Date());
        const msg = JSON.stringify(data);
        socket.emit('chat message', msg);
        scrollToBottom();
      }
      $('#comment').val('');
      $('#comment').focus();
    }
    $(function() {
      const domain = config["<%= process.env.NODE_ENV %>" || "local"].domain;
      var socket = io(domain, {
        withCredentials: true
      });
      socket.on('chat message', (msg) => {
        const message = JSON.parse(msg);
        if ($('#chatgroupid').text() == message.chatgroupId) {
          if ($('#userid').text() != message.userId) {
            appendMess(message.mess, 'receiver', new Date());
            scrollToBottom();
          }
        }
      });
      $('#btnSend').click(() => {
        sendMess(socket);
      });
      $('#btnMicro').click(() => {
        scrollToBottom();
      });
      $('#comment').keydown((e) => {
        const key = e.which;
        if (key == 13) $('#btnSend').click();
      });
      $("div[class^='row sideBar-body']").click(showGroup);
      // $('#btnShowMoreMessage').click(showMoreMessage);
    });
  </script>
</body>

</html>